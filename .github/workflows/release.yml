---
name: Build and Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

env:
  PACKER_OUTPUT: packer/outputs/debian12-virtualbox-amd64/debian12-virtualbox.box
  REGISTRY: pluggero
  BOX_NAME: debian12-ansible
  SHORT_DESCRIPTION: Debian12 Vagrant box for Ansible Role Testing.
  PROVIDER: virtualbox
  ARCHITECTURE: amd64
  VBOX_VERSION: "7.1.12"

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/_lint.yml

  build:
    name: Build
    uses: ./.github/workflows/_build.yml
    needs: lint
    with:
      upload-artifact: true

  release:
    name: Release to HashiCorp Cloud
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write
      attestations: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Download box artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: vagrant-box
          path: ./box

      - name: Set Release Version
        id: set_version
        run: echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Read tag message
        id: tag_message
        run: |
          git tag -d ${GITHUB_REF_NAME} || true
          git fetch --prune --unshallow --tags
          TAG_MESSAGE=$(git for-each-ref --format='%(contents:subject)' refs/tags/${GITHUB_REF_NAME})
          TAG_MESSAGE="${TAG_MESSAGE:-Release version ${GITHUB_REF_NAME}}"
          echo "tag_message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get commit SHA and workflow URL
        id: build_metadata
        run: |
          echo "commit_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "workflow_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> $GITHUB_OUTPUT

      - name: Authenticate to HCP
        id: hcp_auth
        run: |
          set -euo pipefail

          echo "Authenticating to HashiCorp Cloud Platform (HCP)..."

          response=$(curl --silent --location "https://auth.idp.hashicorp.com/oauth2/token" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${{ secrets.HCP_CLIENT_ID }}" \
            --data-urlencode "client_secret=${{ secrets.HCP_CLIENT_SECRET }}" \
            --data-urlencode "grant_type=client_credentials" \
            --data-urlencode "audience=https://api.cloud.hashicorp.com")

          token=$(echo "$response" | jq -r .access_token)

          if [[ -z "$token" || "$token" == "null" ]]; then
            echo "Error: Failed to retrieve access token from HCP authentication response."
            exit 1
          fi

          echo "::add-mask::$token"
          echo "token=$token" >> $GITHUB_OUTPUT

          echo "Authentication successful."

      - name: Prepare box upload
        id: prepare_box
        run: |
          set -euo pipefail

          ACCESS_TOKEN="${{ steps.hcp_auth.outputs.token }}"
          BOX_NAME="${{ env.BOX_NAME }}"
          VERSION="${{ steps.set_version.outputs.version }}"
          PROVIDER="${{ env.PROVIDER }}"
          ARCHITECTURE="${{ env.ARCHITECTURE }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"

          echo "Starting box preparation..."

          echo "Checking if box '$BOX_NAME' exists..."

          response=$(curl --silent --header "Authorization: Bearer $ACCESS_TOKEN" \
              --url "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/box/${BOX_NAME}")

          if echo "$response" | grep -q '"code":5'; then
            echo "Box does not exist. Creating box '$BOX_NAME'..."
            curl --silent --fail --request POST --header "Authorization: Bearer $ACCESS_TOKEN" \
              --header "Content-Type: application/json" \
              --data '{"name":"'"$BOX_NAME"'","description":"'"$REPO_URL"'","short_description":"'"$SHORT_DESCRIPTION"'","is_private":false}' \
              "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/boxes" | jq .
            echo "Box created."
          else
            echo "Box already exists."
          fi

          echo
          echo "Checking if version '$VERSION' exists for box '$BOX_NAME'..."

          version_response=$(curl --silent \
              --url "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/box/${BOX_NAME}/version/${VERSION}/provider/${PROVIDER}/architecture/${ARCHITECTURE}/download")

          if echo "$version_response" | grep -q '"code":5'; then
            echo "Version does not exist. Creating version '$VERSION'..."

            # Construct description with build metadata
            DESCRIPTION="${{ steps.tag_message.outputs.tag_message }}

          Build Information
          - VirtualBox version: ${VBOX_VERSION}
          - Git commit: ${{ steps.build_metadata.outputs.commit_sha }}
          - Build workflow: ${{ steps.build_metadata.outputs.workflow_url }}

          To verify provenance: https://github.com/${{ github.repository }}#verifying-box-provenance"

            curl --silent --fail --request POST --header "Authorization: Bearer $ACCESS_TOKEN" \
              --header "Content-Type: application/json" \
              --data "$(jq -n \
                --arg name "$VERSION" \
                --arg desc "$DESCRIPTION" \
                --arg provider "$PROVIDER" \
                '{name: $name, description: $desc, provider_names: [$provider]}')" \
              "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/box/${BOX_NAME}/versions" | jq .
            echo "Version created."

            echo
            echo "Creating provider '$PROVIDER'..."
            curl --silent --fail --request POST --header "Authorization: Bearer $ACCESS_TOKEN" \
              --url "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/box/${BOX_NAME}/version/${VERSION}/providers" \
              --header "Content-Type: application/json" \
              --data '{
                "name": "'"$PROVIDER"'",
                "summary": {
                  "architectures_count": 1
                },
                "architecture_types": ["'"$ARCHITECTURE"'"]
              }' | jq .
            echo "Provider created."

            echo
            echo "Calculating box checksum..."
            checksum=$(sha256sum ./box/debian12-virtualbox.box | awk '{print $1}')
            echo "Checksum: $checksum"

            echo
            echo "Creating checksums file with metadata..."
            {
              echo "$checksum  debian12-virtualbox.box"
              echo ""
              echo "Build Metadata"
              echo "- Version: $VERSION"
              echo "- Git commit: ${{ steps.build_metadata.outputs.commit_sha }}"
              echo "- Workflow run: ${{ steps.build_metadata.outputs.workflow_url }}"
              echo "- Build date: $(date --utc +"%Y-%m-%d %H:%M:%S UTC")"
              echo "- VirtualBox version: $VBOX_VERSION"
              echo ""
              echo "Repository: ${{ github.server_url }}/${{ github.repository }}"
            } > ./box/checksums.txt
            echo "Checksums file created."

            echo
            echo "Creating architecture '$ARCHITECTURE'..."
            curl --silent --fail --request POST --header "Authorization: Bearer $ACCESS_TOKEN" \
              --url "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/box/${BOX_NAME}/version/${VERSION}/provider/${PROVIDER}/architectures" \
              --header "Content-Type: application/json" \
              --data '{
                "architecture_type": "'"$ARCHITECTURE"'",
                "default": true,
                "box_data": {
                  "checksum": "'"$checksum"'",
                  "checksum_type": "SHA256",
                  "size": "'$(stat --format="%s" ./box/debian12-virtualbox.box)'",
                  "created_at": "'"$(date --utc +"%Y-%m-%dT%H:%M:%SZ")"'",
                  "updated_at": "'"$(date --utc +"%Y-%m-%dT%H:%M:%SZ")"'"
                }
              }' | jq .
            echo "Architecture created."

            echo "skip_upload=false" >> $GITHUB_OUTPUT
          else
            echo "Version already exists."
            echo "skip_upload=true" >> $GITHUB_OUTPUT
          fi

      - name: Attest checksums file
        if: steps.prepare_box.outputs.skip_upload == 'false'
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-path: ./box/checksums.txt

      - name: Upload checksums as artifact
        if: steps.prepare_box.outputs.skip_upload == 'false'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: checksums-${{ steps.set_version.outputs.version }}
          path: ./box/checksums.txt

      - name: Upload box
        if: steps.prepare_box.outputs.skip_upload == 'false'
        run: |
          set -euo pipefail

          ACCESS_TOKEN="${{ steps.hcp_auth.outputs.token }}"
          BOX_NAME="${{ env.BOX_NAME }}"
          VERSION="${{ steps.set_version.outputs.version }}"
          PROVIDER="${{ env.PROVIDER }}"
          ARCHITECTURE="${{ env.ARCHITECTURE }}"

          echo "Starting upload of box '$BOX_NAME' version '$VERSION'..."

          echo
          echo "Fetching upload URL..."
          response=$(curl --silent --header "Authorization: Bearer $ACCESS_TOKEN" \
            "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/box/${BOX_NAME}/version/${VERSION}/provider/${PROVIDER}/architecture/${ARCHITECTURE}/upload")

          upload_url=$(echo "$response" | jq -r .url)

          if [[ -z "$upload_url" || "$upload_url" == "null" ]]; then
            echo "Error: Failed to retrieve upload URL."
            exit 1
          fi

          echo "Upload URL retrieved."

          echo
          echo "Uploading box file..."
          curl --fail --request PUT --upload-file ./box/debian12-virtualbox.box "$upload_url"
          echo "Box upload completed."

          echo
          echo "Finalizing release..."
          curl --silent --fail --request PUT \
            --header "Authorization: Bearer $ACCESS_TOKEN" \
            "https://api.cloud.hashicorp.com/vagrant/2022-09-30/registry/${REGISTRY}/box/${BOX_NAME}/version/${VERSION}/release"

          echo
          echo "Box version released successfully!"
